<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Architecture: Tailwind for styling, React/Babel for Logic -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      /* --- Custom Variables for Coffee Theme --- */
      :root {
          /* Primary Coffee Color (Rich Brown/Amber Equivalent) */
          --color-coffee-primary: #6F4E37; 
          /* Darker Coffee Tone for Hover/Borders */
          --color-coffee-dark: #4B3621; 
          /* Deep Charcoal Backgrounds */
          --color-grey-dark: #1F2937; /* Tailwind Gray-900 */
          --color-grey-medium: #374151; /* Tailwind Gray-700 for Card BG */
          --color-grey-border: #4B5563; /* Tailwind Gray-600/700 for borders */
      }

      /* Custom scrollbar for a native app feel */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: var(--color-grey-dark); }
      ::-webkit-scrollbar-thumb { background: var(--color-grey-medium); border-radius: 10px; }
      body { background-color: var(--color-grey-dark); }
      /* Prevent zoom on mobile inputs */
      input { font-size: 16px; }

      /* Stamp UI Fix: Ensure color changes are prominent and themed */
      .stamp-filled {
        /* Force themed coffee color background */
        background-color: var(--color-coffee-primary) !important; 
        color: #ffffff !important; /* White icon/text for contrast */
        box-shadow: 0 0 10px rgba(111, 78, 55, 0.5) !important; 
        border: 2px solid var(--color-coffee-dark) !important;
      }
      .stamp-filled svg {
        /* Ensure the icon fill uses the white text color */
        fill: currentColor !important;
      }
      .stamp-empty {
        background-color: var(--color-grey-medium) !important; 
        color: #9ca3af !important; /* Gray 400 for empty */
        border: 2px solid var(--color-grey-border) !important; /* Add border to empty for definition */
      }
      .stamp-empty svg {
        fill: none !important; /* Ensure icon is outline only */
      }


      /* Fix: Hides the spin buttons (up/down arrows) for ALL number inputs */
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;
      
      // Constants
      const FREE_ITEM_THRESHOLD = 9;
      const EARLY_REDEMPTION_THRESHOLD = 8;
      const LOCAL_STORAGE_KEY = 'coffeeShopCustomers';
      
      // --- Local Storage Persistence Functions ---
      const loadCustomers = () => {
        try {
          const json = localStorage.getItem(LOCAL_STORAGE_KEY);
          return json ? JSON.parse(json) : [];
        } catch (e) {
          console.error("Could not load data from localStorage", e);
          return [];
        }
      };

      const saveCustomers = (customers) => {
        try {
          localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(customers));
        } catch (e) {
          console.error("Could not save data to localStorage", e);
        }
      };


      // --- Icon Component (Lucide Icons) ---
      const Icon = ({ name, size = 24, className = "" }) => {
        const icons = {
          coffee: <path d="M17 8h1a4 4 0 1 1 0 8h-1M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-3-4Z M6 1v3 M10 1v3 M14 1v3" />,
          creditCard: <><rect width="20" height="14" x="2" y="5" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></>,
          user: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
          plus: <path d="M5 12h14M12 5v14" />,
          minus: <path d="M5 12h14" />,
          chevronLeft: <path d="m15 18-6-6 6-6" />,
          search: <><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>,
          trash2: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />,
          star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />,
          gift: <><rect x="3" y="8" width="18" height="4" rx="1" /><path d="M12 8v13" /><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7" /><path d="M7.5 8a2.5 2.5 0 0 1 0-5C11 4 12 8 12 8s1-4 4.5-4a2.5 2.5 0 0 1 0 5" /><path d="M12 12h.01" /></>,
          dollarSign: <><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></>,
          history: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" /><path d="M3 3v9h9" /><path d="M12 7v5l3 3" /></>,
          checkCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>,
          alertCircle: <><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></>,
          wallet: <><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" /><path d="M3 5v14a2 2 0 0 0 2 2h16v-5" /><path d="M18 12a2 2 0 0 0 0 4h4v-4Z" /></>
        };

        return (
          <svg 
            xmlns="http://www.w3.org/2000/svg" 
            width={size} 
            height={size} 
            viewBox="0 0 24 24" 
            fill="none" 
            stroke="currentColor" 
            strokeWidth="2" 
            strokeLinecap="round" 
            strokeLinejoin="round" 
            className={className}
          >
            {icons[name] || <circle cx="12" cy="12" r="10" />}
          </svg>
        );
      };

      // --- Helper Components ---
      
      const formatDateTime = (dateString) => {
        const date = new Date(dateString);
        // Using local format for flexibility, ensuring time is included
        const datePart = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const timePart = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }); 
        return `${datePart} ${timePart}`;
      };

      const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, type = 'button' }) => {
        const baseStyle = "px-4 py-3 rounded-xl font-semibold transition-all active:scale-95 flex items-center justify-center gap-2 shadow-sm";
        
        const variants = {
          primary: `bg-[var(--color-coffee-primary)] text-white hover:bg-[var(--color-coffee-dark)] disabled:bg-gray-700 disabled:text-gray-400`,
          secondary: `bg-[var(--color-grey-medium)] text-white border border-[var(--color-grey-border)] hover:bg-stone-600 disabled:bg-gray-700 disabled:text-gray-400`,
          danger: "bg-red-900/20 text-red-400 hover:bg-red-900/40 border border-red-900/30 disabled:bg-red-900/50 disabled:text-red-600",
          success: "bg-emerald-600 text-white hover:bg-emerald-700 disabled:bg-emerald-900/50 disabled:text-emerald-400",
          ghost: "bg-transparent text-gray-300 hover:bg-stone-800 shadow-none disabled:text-gray-600"
        };

        return (
          <button 
            type={type}
            onClick={onClick} 
            disabled={disabled}
            className={`${baseStyle} ${variants[variant]} ${className}`}
          >
            {children}
          </button>
        );
      };

      const Card = ({ children, className = '' }) => (
        <div className={`bg-[var(--color-grey-medium)] rounded-2xl shadow-lg border border-[var(--color-grey-border)] ${className}`}>
          {children}
        </div>
      );
      
      const HistoryItem = ({ item }) => {
        let descriptionColorClass = 'text-white'; 
        let amountColorClass = 'text-gray-300'; 
        let iconBgClass = 'bg-stone-700/50 text-gray-400';
        let amountText;

        if (item.type === 'payment') {
            // Payment: Amount is stored negative for credit (-500), display positive paid amount
            descriptionColorClass = 'text-emerald-400';
            amountColorClass = 'text-emerald-400';
            iconBgClass = 'bg-emerald-800/50 text-emerald-400';
            amountText = `+ NPR ${Math.abs(item.amount)}`;
        } else if (item.type === 'redeem') {
            // Redemption: 0 amount, label as Free
            descriptionColorClass = 'text-purple-400';
            amountColorClass = 'text-purple-400';
            iconBgClass = 'bg-purple-800/50 text-purple-400';
            amountText = 'Free Item';
        } else if (item.type === 'purchase') {
            // Purchase (Credit/Cash): Tracks cost and stamp
            descriptionColorClass = item.description.includes('Stamp Skipped') ? 'text-amber-400' : 'text-[var(--color-coffee-primary)]'; 
            amountColorClass = 'text-gray-300'; 
            iconBgClass = 'bg-[var(--color-coffee-dark)]/50 text-[var(--color-coffee-primary)]'; 
            
            if (item.subType === 'credit') {
               amountText = `+ NPR ${item.amount} (Credit)`;
            } else if (item.subType === 'cash') {
               // Show actual cash amount, even though it doesn't affect credit
               amountText = `NPR ${item.amount} (Paid)`;
            } else {
               amountText = `NPR ${item.amount}`;
            }
        }

         return (
             <div key={item.id} className="bg-[var(--color-grey-medium)] p-3 rounded-lg border border-[var(--color-grey-border)] flex justify-between items-center text-sm">
                <div className="flex items-center gap-3">
                   <div className={`p-2 rounded-full ${iconBgClass}`}>
                      {item.type === 'payment' && <Icon name="wallet" size={14} />}
                      {item.type === 'purchase' && <Icon name="coffee" size={14} />}
                      {item.type === 'redeem' && <Icon name="gift" size={14} />}
                   </div>
                   <div>
                      <p className={`font-medium ${descriptionColorClass}`}>{item.description}</p>
                      <p className="text-xs text-gray-400">{formatDateTime(item.date)}</p>
                   </div>
                </div>
                <span className={`font-bold ${amountColorClass}`}>
                   {amountText}
                </span>
             </div>
         );
      };


      const Badge = ({ children, type = 'neutral' }) => {
        // Map types to Tailwind class strings
        const styles = {
          neutral: "bg-stone-700 text-gray-300",
          success: "bg-emerald-900/50 text-emerald-400",
          warning: "bg-amber-900/50 text-amber-400",
          danger: "bg-red-900/50 text-red-400"
        };
        // FIX: The class string is now correctly passed to the className prop
        return (
          <span className={`px-2 py-1 rounded-md text-xs font-bold tracking-wide uppercase leading-none ${styles[type]}`}>
            {children}
          </span>
        );
      };

      // --- Main Application Logic ---

      function App() {
        // Application States
        const [customers, setCustomers] = useState([]);
        const [view, setView] = useState('list'); 
        const [activeCustomerId, setActiveCustomerId] = useState(null);
        const [searchQuery, setSearchQuery] = useState('');
        const [newCustomerName, setNewCustomerName] = useState('');
        const [paymentAmount, setPaymentAmount] = useState(''); 
        const [currentPrice, setCurrentPrice] = useState(150);
        const [historyFilterDate, setHistoryFilterDate] = useState('');
        const [confirmDeleteId, setConfirmDeleteId] = useState(null); 
        
        // --- EFFECT 1: Load customers from LocalStorage on mount ---
        useEffect(() => {
            const loaded = loadCustomers();
            // Assign a temporary unique ID (if missing) and ensure history is array
            const sanitized = loaded.map(c => ({
                ...c,
                id: c.id || crypto.randomUUID(),
                history: Array.isArray(c.history) ? c.history : [],
                // Ensure the new flag exists and defaults to false
                skipNextStamp: typeof c.skipNextStamp === 'boolean' ? c.skipNextStamp : false
            }));
            setCustomers(sanitized);
        }, []);
        
        // --- Helper Function to update customer state and localStorage ---
        const updateCustomersState = (newCustomers) => {
            setCustomers(newCustomers);
            saveCustomers(newCustomers);
        };

        const getActiveCustomer = () => customers.find(c => c.id === activeCustomerId);
        
        // --- CRUD Operations ---

        const addCustomer = (e) => {
            e.preventDefault();
            if (!newCustomerName.trim()) return;
            
            const newCustomerData = {
                id: crypto.randomUUID(), // Local unique ID
                name: newCustomerName,
                credit: 0,
                stamps: 0,
                skipNextStamp: false, // NEW: Flag to skip the next stamp after redemption
                history: [], 
                createdAt: new Date().toISOString(),
            };

            const newCustomers = [...customers, newCustomerData];
            updateCustomersState(newCustomers);
            
            setNewCustomerName('');
            setActiveCustomerId(newCustomerData.id);
            setView('detail');
        };

        const deleteCustomer = (customerId) => {
            const newCustomers = customers.filter(c => c.id !== customerId);
            updateCustomersState(newCustomers);
            
            setView('list');
            setActiveCustomerId(null);
            setConfirmDeleteId(null);
        };
        
        const updateCustomer = (customerId, updates) => {
            const newCustomers = customers.map(c => 
                c.id === customerId ? { ...c, ...updates } : c
            );
            updateCustomersState(newCustomers);
        };
        
        const updateSingleCustomer = (updates) => {
             updateCustomer(activeCustomerId, updates);
        }

        // --- Transaction Handlers ---

        const handleTransaction = (type) => {
            const customer = getActiveCustomer();
            if (!customer) return;

            const price = Number(currentPrice);
            let newStamps = customer.stamps;
            let newCredit = customer.credit;
            let newSkipNextStamp = customer.skipNextStamp; 
            let description = '';
            let amount = price; 
            let historyType = 'purchase';
            let historySubType = ''; 

            if (type === 'credit_coffee' || type === 'cash_coffee') {
                
                // --- STAMP LOGIC: Check if the stamp should be skipped (Only occurs after Early Redeem) ---
                if (customer.skipNextStamp) {
                    // Skip stamp for this transaction and reset the flag
                    newStamps = customer.stamps; // Stays the same
                    newSkipNextStamp = false;   // Reset the flag for the next transaction
                    description = type === 'credit_coffee' ? 
                        'Coffee on Credit (Stamp Skipped due to Early Redemption)' :
                        'Coffee (Paid Cash/Card, Stamp Skipped due to Early Redemption)';
                    
                } else {
                    // Normal stamp logic: increment
                    newStamps = Math.min(FREE_ITEM_THRESHOLD, customer.stamps + 1);
                    description = type === 'credit_coffee' ? 
                        'Coffee on Credit (Tab Increased, Stamp Earned)' :
                        'Coffee (Paid Cash/Card, Stamp Earned)';
                    newSkipNextStamp = false; // Ensure false
                }
                
                // --- CREDIT LOGIC: Only affects credit_coffee ---
                if (type === 'credit_coffee') {
                    newCredit = customer.credit + price;
                    historySubType = 'credit';
                } else {
                    newCredit = customer.credit; // Cash/Card doesn't change credit tab
                    historySubType = 'cash';
                }
            }
            
            else if (type === 'redeem') {
                const isEarlyRedeem = customer.stamps < FREE_ITEM_THRESHOLD;
                
                // Redemption always resets stamps to 0
                newStamps = 0; 
                description = 'Free Loyalty Coffee Used (Reward)';
                amount = 0; 
                historyType = 'redeem';
                historySubType = isEarlyRedeem ? 'early_free' : 'standard_free'; 
                
                // NEW LOGIC: Only set the skipNextStamp flag for Early Redemption
                if (isEarlyRedeem) {
                    // Early Redemption (8 stamps): Skips the next stamp
                    newSkipNextStamp = true; 
                    description = 'Early Free Coffee Used (Reward) - Next Stamp Skipped';
                } else {
                    // Standard Redemption (9 stamps): Does NOT skip the next stamp
                    newSkipNextStamp = false; 
                    description = 'Standard Free Coffee Used (Reward)';
                }
            } else {
                return;
            }

            const historyEntry = {
                id: Date.now(),
                date: new Date().toISOString(),
                type: historyType,
                subType: historySubType,
                description: description,
                amount: amount
            };
            
            const updatedHistory = [historyEntry, ...customer.history];

            updateSingleCustomer({
                credit: newCredit,
                stamps: newStamps,
                skipNextStamp: newSkipNextStamp, // <-- Update the new flag
                history: updatedHistory
            });
        };
        
        const adjustStamps = (amount) => {
            const customer = getActiveCustomer();
            if (!customer) return;

            // Manual adjustment: bypass the maximum limit if adding, but not above 9
            const newStamps = Math.max(0, Math.min(FREE_ITEM_THRESHOLD, customer.stamps + amount));
            updateSingleCustomer({ stamps: newStamps });
        }

        const submitPayment = () => {
           const customer = getActiveCustomer();
           const amount = Number(paymentAmount);
           
           if (isNaN(amount) || amount <= 0 || !customer) {
             console.error("Invalid payment amount or missing customer.");
             return; 
           }
           
           // Credit decreases when customer pays (or increases if they overpay)
           const newCredit = customer.credit - amount;
           
           const entry = {
              id: Date.now(),
              date: new Date().toISOString(),
              type: 'payment',
              description: amount > customer.credit ? 'Tab Overpayment / Deposit' : 'Tab Payment Received',
              amount: -amount // Store payment as a negative value (decreasing the tab)
           };
           
           const updatedHistory = [entry, ...customer.history];

           updateSingleCustomer({
               credit: newCredit, 
               history: updatedHistory
           });
           
           setPaymentAmount(''); // Clear the input
           setView('detail'); // Return to the detail view
        };
        
        // --- View Renderers ---
        const renderCustomerList = () => {
          const filtered = customers.filter(c => 
            c.name.toLowerCase().includes(searchQuery.toLowerCase())
          ).sort((a, b) => a.name.localeCompare(b.name));


          return (
            <div className="max-w-md mx-auto min-h-screen bg-[var(--color-grey-dark)] pb-20 font-sans">
              <div className="bg-[var(--color-grey-dark)] p-6 sticky top-0 z-10 border-b border-[var(--color-grey-border)] shadow-xl">
                <div className="flex justify-between items-center mb-4">
                  <div>
                    <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                      <Icon name="coffee" className="text-[var(--color-coffee-primary)]" /> BrewKeeper
                    </h1>
                    <p className="text-stone-400 text-sm">Customer Loyalty & Tabs (Local Storage)</p>
                  </div>
                  <button 
                    onClick={() => setView('new')}
                    className="bg-[var(--color-coffee-primary)] text-white p-2 rounded-full shadow-lg hover:bg-[var(--color-coffee-dark)] transition"
                  >
                    <Icon name="plus" size={24} />
                  </button>
                </div>
                
                <div className="relative">
                  <div className="absolute left-3 top-3 text-gray-400">
                     <Icon name="search" size={18} />
                  </div>
                  <input 
                    type="text"
                    placeholder="Search customers..."
                    className="w-full pl-10 pr-4 py-2 bg-stone-800 text-white rounded-xl border-none focus:ring-2 focus:ring-[var(--color-coffee-primary)] outline-none placeholder-stone-400"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                  />
                </div>
              </div>

              {customers.length === 0 && (
                 <div className="p-4 text-center text-gray-400">
                    <p>Welcome! Add your first customer above.</p>
                 </div>
              )}
              
              {customers.length > 0 && (
                  <div className="p-4 space-y-3">
                    {filtered.length === 0 ? (
                      <div className="text-center py-10 text-gray-500">
                        <div className="mx-auto mb-2 opacity-20 flex justify-center text-gray-600">
                            <Icon name="user" size={48} />
                        </div>
                        <p>No customers found matching "{searchQuery}".</p>
                      </div>
                    ) : (
                      filtered.map(customer => (
                        <div 
                          key={customer.id}
                          onClick={() => { setActiveCustomerId(customer.id); setView('detail'); }}
                          className="bg-[var(--color-grey-medium)] p-4 rounded-xl shadow-lg border border-[var(--color-grey-border)] active:bg-stone-700 transition cursor-pointer flex justify-between items-center"
                        >
                          <div>
                            <h3 className="font-bold text-white">{customer.name}</h3>
                            <div className="flex items-center gap-2 mt-1">
                              {customer.credit > 0 ? (
                                <Badge type='danger'>NPR {customer.credit} Due</Badge>
                              ) : customer.credit < 0 ? (
                                <Badge type='success'>NPR {Math.abs(customer.credit)} ADVANCE</Badge>
                              ) : (
                                <Badge type='neutral'>Settled</Badge>
                              )}
                              
                              <span className="text-xs text-gray-400 flex items-center gap-1">
                                <Icon name="star" size={12} className="text-[var(--color-coffee-primary)] fill-[var(--color-coffee-primary)]" />
                                {customer.stamps} / {FREE_ITEM_THRESHOLD}
                              </span>
                            </div>
                          </div>
                          <Icon name="chevronLeft" className="rotate-180 text-gray-500" />
                        </div>
                      ))
                    )}
                  </div>
              )}
            </div>
          );
        };

        const renderHistoryDetail = () => {
           const customer = getActiveCustomer();
           if (!customer) return null;

           // Sort locally for display consistency, then filter
           const filteredHistory = customer.history
              .sort((a, b) => new Date(b.date) - new Date(a.date))
              .filter(item => {
               if (!historyFilterDate) return true;
               // Filter by date (YYYY-MM-DD)
               return item.date.startsWith(historyFilterDate);
           });

           return (
              <div className="max-w-md mx-auto min-h-screen bg-[var(--color-grey-dark)] pb-6 font-sans">
                 <div className="bg-[var(--color-grey-dark)] p-4 sticky top-0 z-10 flex items-center gap-4 border-b border-[var(--color-grey-border)]">
                    <button onClick={() => setView('detail')} className="p-2 hover:bg-stone-800 rounded-full">
                       <Icon name="chevronLeft" className="text-white" />
                    </button>
                    <h2 className="font-bold text-lg flex-1 truncate text-white">All Activity for {customer.name}</h2>
                 </div>

                 <div className="p-4">
                    <div className="mb-4">
                       <label className="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Filter by Date</label>
                       <input 
                           type="date"
                           value={historyFilterDate}
                           onChange={(e) => setHistoryFilterDate(e.target.value)}
                           className="w-full p-3 bg-stone-800 text-white border border-[var(--color-grey-border)] rounded-xl outline-none focus:ring-2 focus:ring-[var(--color-coffee-primary)]"
                       />
                       {historyFilterDate && (
                           <button 
                               onClick={() => setHistoryFilterDate('')}
                               className="mt-2 text-sm text-red-400 hover:text-red-300"
                           >
                               Clear Filter
                           </button>
                       )}
                    </div>

                    <div className="space-y-2">
                       {filteredHistory.length > 0 ? (
                          filteredHistory.map(item => <HistoryItem key={item.id} item={item} />)
                       ) : (
                          <p className="text-center text-gray-500 text-sm py-10">No activities found matching the filter.</p>
                       )}
                    </div>
                 </div>
              </div>
           );
        };

        const renderPaymentModal = () => {
            const customer = getActiveCustomer();
            if (!customer) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 font-sans">
                    <Card className="w-full max-w-sm p-6 space-y-4">
                        <h3 className="text-xl font-bold text-white">Record Payment/Deposit</h3>
                        <p className="text-sm text-gray-400">
                           {customer.name} currently owes: <span className={`font-bold ${customer.credit > 0 ? 'text-red-400' : 'text-emerald-400'}`}>
                              NPR {Math.abs(customer.credit)} {customer.credit > 0 ? '(Due)' : '(Advance)'}
                           </span>
                        </p>

                        <div>
                            <label htmlFor="amount" className="block text-sm font-medium text-gray-300 mb-2">Amount Paid (NPR)</label>
                            <input
                                id="amount"
                                type="number"
                                placeholder="e.g. 500"
                                value={paymentAmount}
                                onChange={(e) => setPaymentAmount(e.target.value)}
                                className="w-full p-3 bg-stone-800 text-white rounded-xl border-none focus:ring-2 focus:ring-emerald-400 outline-none"
                                min="1"
                                step="any" // Allows decimal input if needed
                            />
                        </div>

                        <div className="flex justify-end gap-3 pt-2">
                            <Button variant="secondary" onClick={() => { setPaymentAmount(''); setView('detail'); }}>
                                Cancel
                            </Button>
                            <Button 
                                variant="success" 
                                onClick={submitPayment} 
                                disabled={!paymentAmount || Number(paymentAmount) <= 0}
                            >
                                <Icon name="checkCircle" size={20} /> Record Payment
                            </Button>
                        </div>
                    </Card>
                </div>
            );
        };
        
        const renderDeleteConfirmationModal = () => {
            if (!confirmDeleteId) return null;
            const customer = customers.find(c => c.id === confirmDeleteId);
            if (!customer) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 font-sans">
                    <Card className="w-full max-w-sm p-6 space-y-4">
                        <h3 className="text-xl font-bold text-red-400 flex items-center gap-2">
                           <Icon name="alertCircle" size={24} /> Confirm Deletion
                        </h3>
                        <p className="text-sm text-gray-300">
                           Are you sure you want to permanently delete the profile for <span className="font-semibold text-white">{customer.name}</span>? 
                           This action cannot be undone and will remove all associated credit/stamp history.
                        </p>
                        
                        <div className="flex justify-end gap-3 pt-2">
                            <Button 
                                variant="secondary" 
                                onClick={() => setConfirmDeleteId(null)}
                            >
                                Cancel
                            </Button>
                            <Button 
                                variant="danger" 
                                onClick={() => deleteCustomer(confirmDeleteId)}
                            >
                                <Icon name="trash2" size={20} /> Delete Permanently
                            </Button>
                        </div>
                    </Card>
                </div>
            );
        };


        const renderCustomerDetail = () => {
          const customer = getActiveCustomer();
          if (!customer) return null;

          const isEligibleForReward = customer.stamps >= FREE_ITEM_THRESHOLD;
          const isEarlyRedeemAvailable = customer.stamps >= EARLY_REDEMPTION_THRESHOLD && !isEligibleForReward;

          const handleDeleteProfile = () => {
             setConfirmDeleteId(customer.id);
          };


          return (
            <div className="max-w-md mx-auto min-h-screen bg-[var(--color-grey-dark)] pb-6 font-sans">
              <div className="bg-[var(--color-grey-dark)] p-4 sticky top-0 z-10 flex items-center gap-4 border-b border-[var(--color-grey-border)]">
                <button onClick={() => setView('list')} className="p-2 hover:bg-stone-800 rounded-full">
                  <Icon name="chevronLeft" className="text-white" />
                </button>
                <h2 className="font-bold text-lg flex-1 truncate text-white">{customer.name}</h2>
                <button 
                  onClick={handleDeleteProfile} 
                  className="text-red-400 hover:text-red-300"
                >
                  <Icon name="trash2" size={18} />
                </button>
              </div>

              <div className="p-4 space-y-6">
                
                {/* Account Summary Card */}
                <Card className="p-5">
                    <h3 className="text-stone-400 text-xs uppercase font-bold tracking-wider mb-2">Account Balance</h3>
                    <div className="flex justify-between items-center">
                        <p className={`text-4xl font-extrabold ${customer.credit > 0 ? 'text-red-400' : 'text-emerald-400'}`}>
                            NPR {Math.abs(customer.credit)}
                        </p>
                        <Badge type={customer.credit > 0 ? 'danger' : customer.credit < 0 ? 'success' : 'neutral'}>
                            {customer.credit > 0 ? 'AMOUNT DUE' : customer.credit < 0 ? 'ADVANCE' : 'CLEARED'}
                        </Badge>
                    </div>
                </Card>

                {/* Loyalty Card (Dark Mode) */}
                <Card className="p-5 space-y-4 overflow-hidden relative">
                  <div className="flex justify-between items-end">
                    <div>
                      <h3 className="text-stone-400 text-xs uppercase font-bold tracking-wider">Loyalty Card</h3>
                      <div className="flex items-center gap-3">
                        <p className="text-2xl font-bold text-[var(--color-coffee-primary)]">
                          {customer.stamps} <span className="text-sm font-normal text-stone-400">/ {FREE_ITEM_THRESHOLD}</span>
                        </p>
                        {/* Manual Stamp Controls (Dark Mode) */}
                        <div className="flex gap-1">
                          <button onClick={() => adjustStamps(-1)} className="p-1 bg-stone-700 rounded hover:bg-stone-600 text-white disabled:opacity-50" disabled={customer.stamps <= 0}>
                            <Icon name="minus" size={12} />
                          </button>
                          <button onClick={() => adjustStamps(1)} className="p-1 bg-stone-700 rounded hover:bg-stone-600 text-white disabled:opacity-50" disabled={customer.stamps >= FREE_ITEM_THRESHOLD}>
                            <Icon name="plus" size={12} />
                          </button>
                        </div>
                      </div>
                    </div>
                    {/* Coffee icon uses the primary color (with opacity) */}
                    <div className="absolute -right-4 -top-4 opacity-10 text-[var(--color-coffee-primary)]">
                       <Icon name="coffee" size={96} />
                    </div>
                  </div>
                  
                  {customer.skipNextStamp && (
                    <div className="flex items-center gap-2 p-3 bg-red-900/30 rounded-lg text-red-300 text-xs font-semibold">
                        <Icon name="alertCircle" size={16} className="shrink-0 mt-0.5" />
                        <p>STAMP SKIPPED: The next purchase will not earn a stamp (due to recent **Early Redemption**).</p>
                    </div>
                  )}

                  <div className="grid grid-cols-5 gap-3 mb-6">
                    {[...Array(FREE_ITEM_THRESHOLD + 1)].map((_, i) => {
                      const isFreeItemSpot = i === FREE_ITEM_THRESHOLD;
                      const filled = i < customer.stamps;
                      
                      return (
                        <div 
                          key={i}
                          className={`
                            aspect-square rounded-lg flex items-center justify-center transition-all duration-300
                            ${isFreeItemSpot 
                                ? (isEligibleForReward ? 'border-emerald-500 bg-emerald-900/30 text-emerald-400 animate-pulse border-dashed border-2' : 'border-[var(--color-grey-border)] text-stone-600 border-dashed border-2')
                                : (filled ? 'stamp-filled scale-100' : 'stamp-empty scale-95')
                            }
                          `}
                        >
                           {isFreeItemSpot ? <Icon name="gift" size={20} /> : <Icon name="coffee" size={16} className={filled ? 'fill-current' : ''} />}
                        </div>
                      );
                    })}
                  </div>

                  {isEligibleForReward && (
                    <Button onClick={() => handleTransaction('redeem')} variant="success" className="w-full">
                      <Icon name="gift" size={20} /> Redeem Free Coffee (Standard)
                    </Button>
                  )}

                  {isEarlyRedeemAvailable && (
                    <div className="space-y-2">
                      <div className="flex items-start gap-2 p-3 bg-amber-900/30 rounded-lg text-amber-300 text-xs">
                        <Icon name="alertCircle" size={16} className="shrink-0 mt-0.5" />
                        <p>Early redemption available ({customer.stamps}/{FREE_ITEM_THRESHOLD} stamps). This will grant the free coffee now, but skip the stamp on the very next purchase.</p>
                      </div>
                      <Button onClick={() => handleTransaction('redeem')} variant="secondary" className="w-full text-amber-400 border-amber-900/50 hover:bg-amber-900/30">
                         Redeem Early (Skip Next Stamp)
                      </Button>
                    </div>
                  )}
                  {/* Show standard info if not eligible/early eligible */}
                  {!isEligibleForReward && !isEarlyRedeemAvailable && !customer.skipNextStamp && (
                    <p className="text-center text-sm text-gray-400">
                      Collect <span className="font-bold text-white">{FREE_ITEM_THRESHOLD - customer.stamps}</span> more stamps for a free coffee.
                    </p>
                  )}
                </Card>

                {/* Transaction/Action Panel */}
                <Card className="p-5 space-y-4">
                    <h3 className="text-stone-400 text-xs uppercase font-bold tracking-wider">Quick Actions</h3>
                    
                    <div className="grid grid-cols-2 gap-3">
                        <Button onClick={() => handleTransaction('credit_coffee')} variant="primary" disabled={isEligibleForReward}>
                            <Icon name="creditCard" size={20} /> Credit Coffee
                        </Button>
                        <Button onClick={() => handleTransaction('cash_coffee')} variant="secondary" disabled={isEligibleForReward}>
                            <Icon name="coffee" size={20} /> Cash/Card Coffee
                        </Button>
                        <Button onClick={() => setView('payment_modal')} variant="secondary" className="col-span-2">
                            <Icon name="wallet" size={20} /> Record Payment/Deposit
                        </Button>
                    </div>

                    <div className="flex items-center gap-3 pt-3">
                        <label className="text-sm font-medium text-gray-300 whitespace-nowrap">Coffee Price (NPR):</label>
                        <input
                            type="number"
                            value={currentPrice}
                            onChange={(e) => setCurrentPrice(Math.max(0, Number(e.target.value)))}
                            className="w-full p-2 bg-stone-800 text-white rounded-lg text-center border-none focus:ring-1 focus:ring-[var(--color-coffee-primary)] outline-none"
                            min="0"
                            step="any"
                        />
                    </div>
                </Card>

                {/* History Preview */}
                <Card className="p-5 space-y-3">
                    <div className="flex justify-between items-center">
                        <h3 className="text-stone-400 text-xs uppercase font-bold tracking-wider">Recent Activity</h3>
                        <Button onClick={() => setView('history')} variant="ghost" className="px-2 py-1 text-sm">
                            View All <Icon name="history" size={16} />
                        </Button>
                    </div>
                    <div className="space-y-2">
                        {customer.history.slice(0, 3).map(item => (
                            <HistoryItem key={item.id} item={item} />
                        ))}
                        {customer.history.length === 0 && (
                            <p className="text-center text-gray-500 text-sm pt-4">No recent activity recorded.</p>
                        )}
                    </div>
                </Card>

              </div>
            </div>
          );
        };

        const renderNewCustomer = () => {
          return (
            <div className="max-w-md mx-auto min-h-screen bg-[var(--color-grey-dark)] pb-6 font-sans">
              <div className="bg-[var(--color-grey-dark)] p-4 sticky top-0 z-10 flex items-center gap-4 border-b border-[var(--color-grey-border)]">
                <button onClick={() => setView('list')} className="p-2 hover:bg-stone-800 rounded-full">
                  <Icon name="chevronLeft" className="text-white" />
                </button>
                <h2 className="font-bold text-lg text-white">Add New Customer</h2>
              </div>

              <form onSubmit={addCustomer} className="p-4 space-y-4">
                <Card className="p-5 space-y-3">
                    <label htmlFor="customerName" className="block text-sm font-medium text-gray-300">Customer Name</label>
                    <input
                      id="customerName"
                      type="text"
                      placeholder="e.g. Ram Bahadur"
                      value={newCustomerName}
                      onChange={(e) => setNewCustomerName(e.target.value)}
                      required
                      className="w-full p-3 bg-stone-800 text-white rounded-xl border-none focus:ring-2 focus:ring-[var(--color-coffee-primary)] outline-none placeholder-stone-400"
                    />
                </Card>
                <Button type="submit" variant="primary" className="w-full" disabled={!newCustomerName.trim()}>
                  <Icon name="plus" size={20} /> Create Customer Profile
                </Button>
              </form>
            </div>
          );
        };

        // --- Main Render ---
        let content;
        if (view === 'list') {
          content = renderCustomerList();
        } else if (view === 'detail') {
          content = renderCustomerDetail();
        } else if (view === 'new') {
          content = renderNewCustomer();
        } else if (view === 'history') {
           content = renderHistoryDetail();
        } else if (view === 'payment_modal') {
           content = (
              <>
                 {renderCustomerDetail()} 
                 {renderPaymentModal()}
              </>
           );
        }

        if (confirmDeleteId) {
            content = (
               <>
                   {content}
                   {renderDeleteConfirmationModal()}
               </>
            );
        }

        return content;
      }

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>
